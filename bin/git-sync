#!/bin/bash

# set -x

MASTER_BRANCH="master"
CURRENT_BRANCH="$(git branch --show-current)"

# default to master branch
DEFAULT_MAIN_BRANCH=$MASTER_BRANCH
# if master branch does not exist, fallback to main
if [[ "$(git branch --list "$MASTER_BRANCH")" == "" ]]; then
  DEFAULT_MAIN_BRANCH="main"
fi

TARGET_BRANCH=${1:-$CURRENT_BRANCH}
SOURCE_BRANCH=${2:-$DEFAULT_MAIN_BRANCH}



if [[ "$CURRENT_BRANCH" == "$SOURCE_BRANCH" ]]; then
  git rebase origin "$SOURCE_BRANCH"
  sync_result="$?"
else
  git fetch --no-tags origin "$SOURCE_BRANCH":"$SOURCE_BRANCH"
  sync_result="$?"
fi

if [[ ! $sync_result -eq "0" ]]; then
  echo "üö® Failure to update source branch [$SOURCE_BRANCH]"
  exit 1
fi

target="$(git branch-grep "$TARGET_BRANCH")"

if [ -z "$target" ]; then
  echo "‚ùå $TARGET_BRANCH does not exist."
  exit 1
fi

git rebase --apply "$SOURCE_BRANCH" "$target"
