#!/usr/bin/env bash

# set -x

stderr() {
  echo "$@" >&2
}

args=("$@")

if [[ $# -gt 0 ]]; then
  token_list=("$@")
  # stderr "token_list[*]=${token_list[*]}"
  last_index=$((${#token_list[@]} - 1))
  # stderr "last_index=$last_index"
  last_token="${token_list[$last_index]}"
  # stderr "last_token=$last_token"

  unset 'token_list[${#token_list[@]}-1]'
  # stderr "token_list[*]=${token_list[*]}"

  # check for special "." and ".."
  if [[ "$last_token" == "." || "$last_token" == ".." ]]; then
    stderr "$(color -f dim "git l") $(color -f dim "$last_token")"
    args=("${token_list[@]}" "$last_token")
  # check for exact file
  elif [[ -f "$last_token" ]]; then
    stderr "$(color -f dim "git l") $(color -f dim "$last_token")"
    args=("${token_list[@]}" "$last_token")
  else
    # check for branch match
    maybe_branch=$(git branch-grep -q "$last_token")
    git branch-grep -q "$last_token"
    if [[ -n "$maybe_branch" ]]; then
      stderr "$(color -f dim "git b") $(color -f dim "$last_token") $(color -f dim "â†’") $(color -f yellow "$maybe_branch")"
      args=("${token_list[@]}" "$maybe_branch")
    fi
  fi
fi

# stderr "args[*]=${args[*]}"

terminal_width=$(tput cols)

# estimate the number of color characters per line
# assuming an average of 5 color changes per line and 5 characters per color code
color_buffer=$((12 * 5))
truncation_width=$((terminal_width + color_buffer))

# get the number of characters in the short sha for this repo
SHORT_SHA="$(git log -1 --format=%h)"
SHORT_SHA_LENGTH=${#SHORT_SHA}
SHA_COLUMN_SIZE=$((SHORT_SHA_LENGTH + 1))

# SHA hash - At least 9 characters wide, truncated
SHA_FORMAT="%C(green)%<($SHA_COLUMN_SIZE,trunc)%h"

# relative commit date - 15 characters wide, truncated
DATE_FORMAT="%C(white)%<(15,trunc)%cr"

# author's abbreviated name - 12 characters wide, truncated
AUTHOR_FORMAT="%C(white)%<(8,trunc)%al"

# decorative information like branch heads or tags
DECORATION_FORMAT="%C(auto)%d"

# commit subject - 80 characters wide, truncated
SUBJECT_FORMAT="%<(60,trunc)%s"

# combine all the above formats into one
FORMAT="$SHA_FORMAT $DATE_FORMAT $AUTHOR_FORMAT $DECORATION_FORMAT $SUBJECT_FORMAT"

# view the SHA, description and history graph of last 20 commits
git log --pretty=format:"$FORMAT" -n20 --graph --color ${args[*]} | cut -c 1-"$truncation_width" | nl -w3 -s' '
