#!/usr/bin/env bash

set -euo pipefail

stderr() {
  echo "$@" >&2
}

run() {
  stderr "$(color -f bright_green '‚ùØ')" "$@"
  "$@"
}

usage() {
  stderr
  stderr "$(color -f bright_white "git agent") ‚Äî create/reuse a worktree for the current repo and run an agent inside it."
  stderr
  stderr "$(color -f bright_white "USAGE")"
  stderr "  git agent [options] <name> [-- <agent args>...]"
  stderr
  stderr "$(color -f bright_white "OPTIONS")"
  stderr "  --shell            Enter an interactive shell in the worktree after the agent exits."
  stderr "  --no-shell         Never enter a shell (default when not attached to a TTY)."
  stderr "  -R, --reset        Reset the worktree to the current repo HEAD (hard reset + clean)."
  stderr "  -D, --rm, --delete Remove the worktree for <name> and exit."
  stderr "  -h, --help         Show this help."
  stderr
  stderr "$(color -f bright_white "ARGS")"
  stderr "  <name>             Worktree name (also used as the new worktree branch name)."
  stderr "  <agent args>       Passed through to the agent binary (after '--')."
  stderr
  stderr "$(color -f bright_white "ENV")"
  stderr "  GIT_AGENT_WORKTREES_ROOT   Root directory for worktrees (default: ~/code/worktrees)"
  stderr "  GIT_AGENT_BINARY           Agent command to run (default: opencode)"
  stderr
  stderr "$(color -f bright_white "EXAMPLES")"
  stderr "  git agent opencode-a"
  stderr "  git agent --shell opencode-a"
  stderr "  git agent -- opencode --model gpt-4.1 --temperature 0"
  stderr "  git agent --delete opencode-a"
  stderr
  stderr "$(color -f dim "Notes: '--shell' is forced off when stdin/stdout aren't TTYs.")"
  exit 2
}

shell_mode="auto"
delete_mode="no"
reset_mode="no"
while [[ $# -gt 0 ]]; do
  case "$1" in
    --shell) shell_mode="yes"; shift ;;
    --no-shell) shell_mode="no"; shift ;;
    -D|--rm|--delete) delete_mode="yes"; shift ;;
    -R|--reset) reset_mode="yes"; shift ;;
    -h|--help) usage ;;
    --) shift; break ;;
    -*) stderr "unknown option: $1"; usage ;;
    *) break ;;
  esac
done

# bash test for "am I running interactively in a terminal?"
# -t FD is true if file descriptor FD points at a TTY (terminal)
# 0 = stdin, 1 = stdout, so true when stdin and stdout are a TTY
# e.g. `echo $(git agent --shell opencode-a)` will trip this safeguard
if [[ ! -t 0 || ! -t 1 ]]; then
  shell_mode="no"
else
  if [[ "$shell_mode" == "auto" ]]; then
    shell_mode="yes"
  fi
fi

worktree_name="${1:-}"

if [[ -z "$worktree_name" ]]; then
  usage
fi

# shift out worktree name so `$@` correct capturing agent binary args
shift

worktrees_root="${GIT_AGENT_WORKTREES_ROOT:-"$HOME/code/worktrees"}"
git_agent_binary="${GIT_AGENT_BINARY:-"opencode"}"

# stderr "shell_mode=$shell_mode"
# stderr "agent_args=$*"
# exit 99

if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  usage
fi

repo_root="$(git rev-parse --show-toplevel)"
repo_origin="$(git -C "$repo_root" remote get-url origin 2>/dev/null || true)"
repo_origin="${repo_origin%.git}"

repo_path=""
case "$repo_origin" in
  git@github.com:*)          repo_path="${repo_origin#git@github.com:}" ;;
  https://github.com/*)      repo_path="${repo_origin#https://github.com/}" ;;
  ssh://git@github.com/*)    repo_path="${repo_origin#ssh://git@github.com/}" ;;
esac

if [[ -z "$repo_path" ]]; then
  repo_path="$(basename "$repo_root")"
  stderr "‚ö†Ô∏è $(color -f yellow WARN): fallback to repository directory name ($(color -f dim "$repo_path"))"
fi

head_commit="$(git -C "$repo_root" rev-parse HEAD)"
worktree_path="$worktrees_root/$repo_path/$worktree_name"

if [[ "$delete_mode" == "yes" ]]; then
  stderr "‚ùå delete worktree ($(color -f dim "$worktree_path"))"
  run git -C "$repo_root" worktree remove --force "$worktree_path"
  exit 0
fi

if [[ "$reset_mode" == "yes" ]]; then
  stderr "üîÑ reset worktree to repo HEAD ($(color -f dim "$head_commit"))"
  run git -C "$worktree_path" checkout --detach --force "$head_commit"
  run git -C "$worktree_path" reset --hard "$head_commit"
  run git -C "$worktree_path" clean -fd
fi

# create worktree if it does not exist
if [[ ! -d "$worktree_path" ]]; then
  run git -C "$repo_root" worktree add --detach "$worktree_path" "$head_commit"
else
  stderr "reuse existing worktree ($(color -f dim "$worktree_path"))"
fi

# ensure dir is an actual worktree
if ! git -C "$worktree_path" rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  stderr "üö® $(color -f red ERROR): worktree path exists but is not a git worktree ($(color -f dim "$worktree_path"))"
  exit 3
fi

if ! command -v "$git_agent_binary" >/dev/null 2>&1; then
  stderr "‚ö†Ô∏è $(color -f yellow WARN): missing agent binary ($(color -f dim "$git_agent_binary"))"
else
  stderr "starting $(color -f cyan "$git_agent_binary") ($(color -f dim "$worktree_path"))"
  run cd "$worktree_path"
  run "$git_agent_binary" "$@"
  stderr "agent exited"
fi

if [[ "$shell_mode" == "yes" ]]; then
  stderr "‚ö†Ô∏è entering shell in worktree, type $(color -f cyan exit) to leave worktree"
  exec "${SHELL:-bash}"
fi
